# Uniswap V3 数学计算详解

## 目录
1. [Tick 系统数学基础](#1-tick-系统数学基础)
2. [价格计算](#2-价格计算)
3. [流动性计算](#3-流动性计算)
4. [滑点计算](#4-滑点计算)
5. [手续费计算](#5-手续费计算)
6. [价格区间计算](#6-价格区间计算)
7. [资本效率计算](#7-资本效率计算)
8. [TWAP 价格预言机](#8-twap-价格预言机)
9. [实际应用示例](#9-实际应用示例)

---

## 1. Tick 系统数学基础

### 1.1 Tick 定义
Tick是价格离散化的基本单位，每个tick代表一个特定的价格点。

**基本公式：**
```
价格 = 1.0001^tick
```

### 1.2 Tick 范围
- **最小Tick**: -887272
- **最大Tick**: +887272
- **价格范围**: 2^(-128) 到 2^128

### 1.3 Tick 间距
不同费率层级的tick间距：
- **0.05%费率**: 间距 = 10
- **0.3%费率**: 间距 = 60
- **1%费率**: 间距 = 200

### 1.4 有效Tick规则
有效的tick必须是tick间距的倍数：
```
tick % tickSpacing = 0
```

---

## 2. 价格计算

### 2.1 基本价格公式
```
价格 = 1.0001^tick
```

### 2.2 价格到Tick转换
```
tick = log(价格) / log(1.0001)
```

### 2.3 sqrtPriceX96 表示
Uniswap V3使用sqrtPriceX96表示价格：
```
sqrtPriceX96 = sqrt(价格) × 2^96
```

### 2.4 价格计算示例
**示例1：计算tick = -276000对应的价格**
```
价格 = 1.0001^(-276000) ≈ 0.0005 ETH/USDC
```

**示例2：计算价格$2000对应的tick**
```
tick = log(2000) / log(1.0001) ≈ -274000
```

**示例3：计算sqrtPriceX96**
```
价格 = 2000
sqrtPriceX96 = sqrt(2000) × 2^96 ≈ 79228162514264337593543950336
```

---

## 3. 流动性计算

### 3.1 流动性定义
流动性L是价格区间内可用的流动性数量，用于计算代币数量。

### 3.2 代币数量计算
在价格区间[tickLower, tickUpper]内：

**代币0数量：**
```
amount0 = L × (sqrt(P_upper) - sqrt(P_lower)) / (sqrt(P_upper) × sqrt(P_lower))
```

**代币1数量：**
```
amount1 = L × (sqrt(P_upper) - sqrt(P_lower))
```

其中：
- P_upper = 1.0001^tickUpper
- P_lower = 1.0001^tickLower
- L = 流动性数量

### 3.3 流动性计算示例
**示例：计算价格区间$1800-$2200的流动性**

给定：
- tickLower = -275500 (对应$1800)
- tickUpper = -274500 (对应$2200)
- 代币0数量 = 1000 USDC
- 代币1数量 = 0.5 ETH

计算：
```
P_lower = 1.0001^(-275500) = 1800
P_upper = 1.0001^(-274500) = 2200

sqrt(P_lower) = sqrt(1800) ≈ 42.43
sqrt(P_upper) = sqrt(2200) ≈ 46.90

L = amount0 × sqrt(P_upper) × sqrt(P_lower) / (sqrt(P_upper) - sqrt(P_lower))
L = 1000 × 46.90 × 42.43 / (46.90 - 42.43) ≈ 1000 × 1990.67 / 4.47 ≈ 445,000
```

---

## 4. 滑点计算

### 4.1 滑点定义
滑点是实际交易价格与预期价格的偏差。

### 4.2 滑点公式
```
滑点 = (预期价格 - 实际价格) / 预期价格 × 100%
```

### 4.3 实际价格计算
在集中流动性池中，实际价格取决于：
1. 当前价格
2. 可用流动性
3. 交易数量

**价格影响公式：**
```
ΔP = Δamount / L
```

其中：
- ΔP = 价格变化
- Δamount = 交易数量
- L = 可用流动性

### 4.4 滑点计算示例
**示例：用100 USDC购买ETH**

给定：
- 当前价格 = $2000 ETH/USDC
- 可用流动性 = 100,000
- 交易数量 = 100 USDC

计算：
```
价格影响 = 100 / 100,000 = 0.001
新价格 = 2000 × (1 + 0.001) = 2002
滑点 = (2002 - 2000) / 2000 × 100% = 0.1%
```

---

## 5. 手续费计算

### 5.1 手续费结构
- **总手续费**: 0.3% (0.05%费率池)
- **总手续费**: 0.3% (0.3%费率池)
- **总手续费**: 1% (1%费率池)

### 5.2 手续费分配
```
手续费 = 交易金额 × 费率
```

### 5.3 累积手续费
手续费按比例分配给流动性提供者：
```
累积手续费 = 总手续费 × (LP份额 / 总流动性)
```

### 5.4 手续费计算示例
**示例：计算$1000交易的手续费**

0.3%费率池：
```
手续费 = 1000 × 0.003 = $3
```

1%费率池：
```
手续费 = 1000 × 0.01 = $10
```

---

## 6. 价格区间计算

### 6.1 价格区间定义
价格区间是LP提供流动性的价格范围，由两个tick值定义。

### 6.2 区间宽度计算
```
区间宽度 = tickUpper - tickLower
```

### 6.3 价格范围计算
```
价格范围 = 1.0001^tickUpper - 1.0001^tickLower
```

### 6.4 区间效率计算
```
区间效率 = 当前价格在区间内的位置
效率 = (当前价格 - 区间下限) / (区间上限 - 区间下限)
```

### 6.5 价格区间计算示例
**示例：计算价格区间$1800-$2200的效率**

给定：
- 当前价格 = $2000
- 区间下限 = $1800
- 区间上限 = $2200

计算：
```
效率 = (2000 - 1800) / (2200 - 1800) = 200 / 400 = 50%
```

---

## 7. 资本效率计算

### 7.1 资本效率定义
资本效率是集中流动性相比全价格范围流动性的效率提升。

### 7.2 效率计算公式
```
资本效率 = 全价格范围流动性 / 集中流动性
```

### 7.3 最大效率
理论上，V3的资本效率可以达到：
```
最大效率 = 价格范围 / 集中区间宽度
```

### 7.4 资本效率计算示例
**示例：计算集中流动性的资本效率**

给定：
- 全价格范围：$0 - $∞
- 集中区间：$1800 - $2200
- 区间宽度：$400

计算：
```
理论最大效率 = ∞ / 400 = ∞
实际效率 = 2000 / 400 = 5倍
```

---

## 8. TWAP 价格预言机

### 8.1 TWAP 定义
时间加权平均价格(Time-Weighted Average Price)是价格预言机的核心。

### 8.2 TWAP 计算公式
```
TWAP = Σ(价格 × 时间权重) / Σ(时间权重)
```

### 8.3 累积价格
```
累积价格 = 价格 × 时间
```

### 8.4 TWAP 计算示例
**示例：计算1小时的TWAP**

给定：
- 时间点1：价格$2000，持续30分钟
- 时间点2：价格$2100，持续30分钟

计算：
```
TWAP = (2000 × 30 + 2100 × 30) / (30 + 30) = (60000 + 63000) / 60 = 2050
```

---

## 9. 实际应用示例

### 9.1 创建价格区间
**目标：为ETH/USDC创建$1800-$2200的价格区间**

步骤：
1. 计算对应的tick值
2. 调整到有效的tick
3. 计算所需代币数量

计算：
```
tickLower = log(1800) / log(1.0001) ≈ -275500
tickUpper = log(2200) / log(1.0001) ≈ -274500

调整到60的倍数（0.3%费率）：
tickLower = -275520
tickUpper = -274440

对应价格：
价格下限 = 1.0001^(-275520) ≈ $1798
价格上限 = 1.0001^(-274440) ≈ $2202
```

### 9.2 流动性管理
**目标：在$2000价格添加流动性**

给定：
- 当前价格 = $2000
- 目标区间 = $1800-$2200
- 代币0数量 = 1000 USDC

计算：
```
P_current = 2000
P_lower = 1800
P_upper = 2200

sqrt(P_current) = sqrt(2000) ≈ 44.72
sqrt(P_lower) = sqrt(1800) ≈ 42.43
sqrt(P_upper) = sqrt(2200) ≈ 46.90

L = 1000 × 46.90 × 42.43 / (46.90 - 42.43) ≈ 445,000

代币1数量 = L × (sqrt(P_upper) - sqrt(P_current))
代币1数量 = 445,000 × (46.90 - 44.72) ≈ 970 USDC
```

### 9.3 滑点分析
**目标：分析$1000交易对价格的影响**

给定：
- 当前价格 = $2000
- 可用流动性 = 100,000
- 交易数量 = 1000 USDC

计算：
```
价格影响 = 1000 / 100,000 = 0.01
新价格 = 2000 × (1 + 0.01) = 2020
滑点 = (2020 - 2000) / 2000 × 100% = 1%
```

### 9.4 手续费收益
**目标：计算LP的手续费收益**

给定：
- 总交易量 = $100,000
- 费率 = 0.3%
- LP份额 = 10%
- 总流动性 = 1,000,000

计算：
```
总手续费 = 100,000 × 0.003 = $300
LP手续费 = 300 × (10% / 100%) = $30
```

---

## 10. 数学公式总结

### 10.1 核心公式
```
价格 = 1.0001^tick
tick = log(价格) / log(1.0001)
sqrtPriceX96 = sqrt(价格) × 2^96
```

### 10.2 流动性公式
```
amount0 = L × (sqrt(P_upper) - sqrt(P_lower)) / (sqrt(P_upper) × sqrt(P_lower))
amount1 = L × (sqrt(P_upper) - sqrt(P_lower))
L = amount0 × sqrt(P_upper) × sqrt(P_lower) / (sqrt(P_upper) - sqrt(P_lower))
```

### 10.3 滑点公式
```
滑点 = (预期价格 - 实际价格) / 预期价格 × 100%
价格影响 = 交易数量 / 可用流动性
```

### 10.4 手续费公式
```
手续费 = 交易金额 × 费率
累积手续费 = 总手续费 × (LP份额 / 总流动性)
```

### 10.5 TWAP公式
```
TWAP = Σ(价格 × 时间权重) / Σ(时间权重)
累积价格 = 价格 × 时间
```

---

## 总结

Uniswap V3的数学计算基于以下核心概念：

1. **Tick系统**: 价格离散化的基础
2. **集中流动性**: 提高资本效率的关键
3. **价格区间**: LP控制风险的工具
4. **滑点计算**: 交易成本的重要指标
5. **手续费机制**: 激励流动性的手段

理解这些数学原理对于有效使用Uniswap V3至关重要，可以帮助用户：
- 优化流动性提供策略
- 计算交易成本
- 管理价格风险
- 最大化收益

---

*本文档专注于Uniswap V3的数学计算原理，不涉及具体的代码实现细节。*
